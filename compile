# Dependencies: Judy, jemalloc
# On MAC OSX, just run 'brew install Judy jemalloc'

# Detect OS
IS_MAC=false;
if [[ "$OSTYPE" == "darwin"* ]]; then
    IS_MAC=true;
fi

GCC="gcc"
if $IS_MAC; then
    GCC="gcc-4.6"
fi

CFLAGS="-fPIC -O3 -g -Wall"

cd src
rm *.o
$GCC $CFLAGS -c breadcrumbs.c util.c trail_decode.c lexicon_decode.c huffman.c ddb_queue.c

# Compile SFMT (SIMD Mersenne Twister random generator)
$GCC -fPIC -DDSFMT_MEXP=521 -c -O3 -fno-strict-aliasing -msse2 -DHAVE_SSE2=1 dsfmt/dSFMT.c

# Compile breadcrumbs lib
$GCC $CFLAGS -o ../libbreadcrumbs.so -lJudy *.o -shared
ar ruv ../libbreadcrumbs.a *.o
ranlib ../libbreadcrumbs.a
echo "Compiled breadcrumbs library."


# Compile Encoder
if $IS_MAC; then
    echo "Can't compile breadcrumbs encoder on Mac because 'readahead' is a linux thing."
else
    $GCC $CFLAGS -ljemalloc -o ../breadcrumbs_encoder breadcrumbs_encoder.c arena.c lexicon_encode.c trail_encode.c trail_encode_model.c ddb_queue.c huffman.c util.c dSFMT.o -lJudy -lpthread -static
fi

cd ..
